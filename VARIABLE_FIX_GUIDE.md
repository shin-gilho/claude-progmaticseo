# 템플릿 변수 치환 문제 해결 가이드

## 🔍 문제 상황

키워드로 콘텐츠를 생성할 때 템플릿 변수가 치환되지 않고 빈 값으로 출력되는 문제가 발생했습니다.

**증상:**
- 제목: "R1049 - 상세 정보" (폴백 값)
- 내용: "질병코드 " (빈 값)

**원인:**
1. 프롬프트에서 `{{키워드}}` 사용 (한글 변수명)
2. 템플릿에서 `{{disease_code}}` 사용 (전달되지 않는 변수)
3. AI 응답 JSON에 필요한 필드 누락

---

## ✅ 해결 방법

### 1단계: 코드 수정 (완료됨)

코드가 다음과 같이 개선되었습니다:

**변수 치환 지원:**
- `{{keyword}}` (영문)
- `{{키워드}}` (한글)
- `{{disease_code}}` (별칭)

이제 프롬프트와 템플릿에서 위 세 가지 변수명을 모두 사용할 수 있습니다.

---

### 2단계: 프롬프트 수정 가이드

#### ❌ 수정 전 (문제가 있는 프롬프트)

```
질병코드: {{키워드}}

제목은 : 질병코드 {{키워드}} 실비 보험금 청구 방법

다음 JSON 형식으로 답변:
{
  "symptom_question": "{{증상을 묻는 질문}}",
  "disease_name_kr": "{{질병명 한글}}",
  ...
}
```

**문제점:**
- `{{키워드}}` 사용 (한글, 하지만 이제 지원됨)
- JSON 예시에 `{{...}}` 형식 사용 → AI가 혼동
- `disease_code` 필드 누락

---

#### ✅ 수정 후 (올바른 프롬프트)

```
질병코드: {{keyword}}

제목: 질병코드 {{keyword}} 실손24 보험금 청구

당신은 질병코드와 실손보험 전문가입니다.
다음 정보를 순수 JSON 형식으로 생성해주세요.

**중요 규칙:**
1. 추가 설명이나 주석 없이 JSON만 반환하세요
2. {{...}} 형식은 사용하지 말고, 실제 값으로 채워주세요
3. 모든 필드는 필수입니다

**JSON 스키마 (실제 값으로 채워주세요):**

```json
{
  "title": "질병코드 {{keyword}} 실손24 보험금 청구",
  "symptom_question": "배가 아파서",
  "disease_name_kr": "급성 복통",
  "disease_name_en": "Acute Abdominal Pain",
  "disease_overview": "급성 복통은 갑자기 발생하는 심한 복부 통증을 의미합니다.",
  "insurance_possible": "가능",
  "insurance_note": "진료 기록과 처방전이 있으면 청구 가능",
  "main_symptoms_summary": "갑작스러운 복부 통증",
  "insurance_status": "외래 진료, 검사비, 입원비 모두 청구 가능",
  "main_causes": "소화불량, 과식, 급성 위염, 맹장염 등",
  "disease_usage_explanation": "이 코드는 복부에 통증이 있지만 정확한 원인이 불명확할 때 사용됩니다. 응급실이나 외래에서 초기 진단 시 자주 사용되는 코드입니다.",
  "usage_criteria": [
    "복부 통증이 주증상인 경우",
    "정확한 진단이 확정되지 않은 상태",
    "외래 또는 응급실 초진 시",
    "추가 검사가 필요한 경우",
    "통증 부위가 불명확한 경우"
  ],
  "disease_tip": "이 코드로 진료받은 후 정확한 진단이 나오면 새로운 질병코드가 부여됩니다. 두 코드 모두 실비 청구 가능합니다.",
  "disease_category": "소화기 질환",
  "detailed_causes": [
    {
      "category": "소화기 문제",
      "description": "급성 위염, 소화불량, 과민성 대장 증후군 등으로 인한 복통"
    },
    {
      "category": "염증성 질환",
      "description": "맹장염, 담낭염, 췌장염 등 장기 염증으로 인한 통증"
    },
    {
      "category": "기타 원인",
      "description": "스트레스성 복통, 식중독, 과식, 배변 장애 등"
    }
  ],
  "detailed_symptoms": [
    "배꼽 주변 또는 복부 전체에 통증 발생",
    "통증이 갑자기 시작되거나 점진적으로 악화",
    "구토, 메스꺼움 동반 가능",
    "식욕 감소, 소화 불량",
    "복부 팽만감 또는 압통"
  ],
  "treatment_process": "<p><strong>1단계: 초기 검사</strong><br>의사는 복부 촉진, 문진을 통해 통증 부위와 강도를 확인합니다. 혈액검사, 소변검사로 염증 여부를 확인합니다.</p><p><strong>2단계: 정밀 검사</strong><br>필요시 복부 초음파, CT, 내시경 등 정밀 검사를 진행하여 정확한 원인을 찾습니다.</p><p><strong>3단계: 치료</strong><br>원인에 따라 약물 치료, 식이 조절, 수액 치료 등을 시행합니다. 심각한 경우 수술이 필요할 수 있습니다.</p>",
  "insurance_claim_intro": "질병코드 {{keyword}}로 진료받은 경우 외래 진료비, 검사비, 입원비 모두 실손보험 청구가 가능합니다.",
  "insurance_table": [
    {
      "situation": "외래 진료 + 약 처방",
      "possible": "⭕ 가능",
      "note": "진료비 + 약제비 모두 청구"
    },
    {
      "situation": "혈액검사/소변검사",
      "possible": "⭕ 가능",
      "note": "검사비 포함 전액 청구 유리"
    },
    {
      "situation": "응급실 내원",
      "possible": "⭕ 가능",
      "note": "응급 상황 확인 시 전액 청구"
    },
    {
      "situation": "입원 치료",
      "possible": "⭕ 가능",
      "note": "입원비 및 치료비 청구"
    },
    {
      "situation": "예방 목적 검진",
      "possible": "❌ 불가능",
      "note": "증상이 있어야 청구 가능"
    }
  ],
  "insurance_warning": "진료 기록과 처방전을 반드시 보관하세요. 여러 번 진료받아도 각각의 진료비는 모두 청구 가능합니다.",
  "custom_faq": [
    {
      "question": "질병코드 {{keyword}}로 여러 번 진료받으면 실비 청구가 거부되나요?",
      "answer": "아니요. 각각의 진료가 별도 사건으로 인정되면 모두 청구 가능합니다. 다만, 동일 사고로 인한 재진은 하나의 사건으로 간주될 수 있습니다."
    },
    {
      "question": "질병코드 {{keyword}} 코드로 응급실에 갔는데 실비 청구가 되나요?",
      "answer": "네, 응급 상황으로 인정되면 응급실 진료비 전액 청구 가능합니다. 다만, 경증 질환으로 판정되면 일부 본인부담금이 발생할 수 있습니다."
    },
    {
      "question": "질병코드 {{keyword}}는 암보험이나 진단비 특약에서도 보장되나요?",
      "answer": "암보험은 암 진단 시만 보장되므로 해당되지 않습니다. 진단비 특약은 약관상 보장 질병에 포함되어야 하므로 보험사에 문의하세요."
    },
    {
      "question": "{{keyword}} 코드로 진료 후 다른 진단이 나왔는데 둘 다 청구할 수 있나요?",
      "answer": "네, 가능합니다. 초기 진단과 최종 진단 모두 별도 진료 기록이 있으면 각각 청구할 수 있습니다."
    }
  ],
  "insurance_coverage_note": "실손보험 청구 가능",
  "claim_rejection_cases": "<p><strong>사례1: 예방 목적 검진</strong><br>증상 없이 건강검진 목적으로 병원 방문 시 진료비는 청구가 거부됩니다. 반드시 증상이 있어야 합니다.</p><p><strong>사례2: 진료 기록 불충분</strong><br>진료 기록이나 처방전이 없으면 청구가 어렵습니다. 진료비 영수증과 진료 확인서를 반드시 받아두세요.</p><p><strong>사례3: 중복 청구</strong><br>동일한 진료에 대해 두 번 청구하면 거부됩니다. 진료 날짜와 내역을 정확히 확인하세요.</p>",
  "summary_description": "복부 통증으로 병원에 갔을 때 자주 사용되는 질병코드로, 실손보험 청구가 가능합니다."
}
```

**위 JSON을 참고하여 질병코드 {{keyword}}에 맞는 실제 내용으로 채워주세요.**
```

**핵심 변경사항:**
1. ✅ `{{키워드}}` → `{{keyword}}` (또는 둘 다 지원됨)
2. ✅ AI에게 "{{...}} 사용 금지" 명시
3. ✅ 실제 예시 데이터 제공
4. ✅ `title` 필드에 "질병코드 {{keyword}} 실손24 보험금 청구" 포함

---

### 3단계: 템플릿 수정 가이드

#### 옵션 A: 변수명 통일 (권장)

템플릿에서 모든 변수를 `{{keyword}}`로 통일하세요.

**수정 전:**
```html
<p>진단서에 '질병코드 {{disease_code}}'라고 적혀있나요?</p>
<h2>질병코드 {{disease_code}} 핵심 정보</h2>
```

**수정 후:**
```html
<p>진단서에 '질병코드 {{keyword}}'라고 적혀있나요?</p>
<h2>질병코드 {{keyword}} 핵심 정보</h2>
```

#### 옵션 B: 변수명 유지

코드가 `{{disease_code}}`, `{{키워드}}` 모두 지원하므로 그대로 사용 가능합니다.

---

### 4단계: Title 생성 방식

프롬프트에서 AI에게 `title` 필드를 반환하도록 지시하세요.

**JSON 응답에 포함:**
```json
{
  "title": "질병코드 {{keyword}} 실손24 보험금 청구",
  ...
}
```

또는 `제목` (한글) 필드도 지원됩니다.

---

## 🧪 테스트 방법

### 1. 프롬프트 수정
- Settings 또는 Generate 페이지에서 프롬프트 수정
- 위의 "✅ 수정 후" 예시 참고

### 2. 템플릿 확인
- Templates 페이지에서 템플릿 열기
- `{{disease_code}}` → `{{keyword}}` 검색 및 치환 (선택)

### 3. 콘텐츠 생성
- Generate 페이지에서 키워드 입력 (예: R1049, C020)
- 생성 실행

### 4. 결과 확인
- History 페이지에서 생성된 포스트 확인
- Title: "질병코드 R1049 실손24 보험금 청구" ✅
- Content: "질병코드 R1049" ✅ (빈 값 아님)

---

## 📋 체크리스트

**프롬프트 수정:**
- [ ] `{{키워드}}` → `{{keyword}}` 변경 (또는 둘 다 사용 가능)
- [ ] "순수 JSON만 반환" 명시
- [ ] "{{...}} 형식 사용 금지" 명시
- [ ] 실제 예시 데이터 제공
- [ ] `title` 필드에 "질병코드 {{keyword}} 실손24 보험금 청구" 포함
- [ ] 모든 필수 필드 포함 (위 JSON 스키마 참고)

**템플릿 수정 (선택):**
- [ ] `{{disease_code}}` → `{{keyword}}` 검색 및 치환
- [ ] `{{키워드}}` → `{{keyword}}` 검색 및 치환 (선택)
- [ ] Handlebars 문법 확인 (`{{#each}}`, `{{#if}}`)

**테스트:**
- [ ] 콘텐츠 생성 테스트 (키워드: R1049, C020)
- [ ] Title 정확성 확인
- [ ] Content 변수 치환 확인
- [ ] 빈 값 없는지 확인

---

## 🔧 지원되는 변수명

코드가 다음 변수명을 자동으로 치환합니다:

| 프롬프트/템플릿 | 치환 값 |
|-----------------|---------|
| `{{keyword}}`   | 키워드 (예: R1049) |
| `{{키워드}}`     | 키워드 (예: R1049) |
| `{{disease_code}}` | 키워드 (예: R1049) |

**권장 사용:**
- 프롬프트: `{{keyword}}` (명확함)
- 템플릿: `{{keyword}}` 또는 `{{disease_code}}` (둘 다 작동)

---

## 🐛 문제 해결

### 여전히 빈 값이 나올 경우

1. **AI 응답 확인:**
   - AI가 실제로 해당 필드를 반환했는지 확인
   - 프롬프트에서 필수 필드 명시

2. **JSON 파싱 확인:**
   - AI 응답이 순수 JSON인지 확인
   - ```json ``` 블록 없이 JSON만 반환하도록 지시

3. **변수명 확인:**
   - 템플릿의 변수명이 AI 응답 JSON의 키와 일치하는지 확인
   - 예: 템플릿에 `{{disease_name_kr}}`이 있으면 JSON에도 `disease_name_kr` 필드 필요

### Title이 폴백 값으로 나올 경우

- AI 응답 JSON에 `title` 또는 `제목` 필드 추가
- 프롬프트에서 명시:
  ```json
  {
    "title": "질병코드 {{keyword}} 실손24 보험금 청구",
    ...
  }
  ```

---

## 📞 도움이 필요하면

1. 생성된 포스트의 Content를 확인하여 어떤 변수가 빈 값인지 파악
2. AI 응답 JSON을 확인하여 해당 필드가 있는지 확인
3. 프롬프트를 수정하여 AI에게 명확히 지시
4. 템플릿 변수명과 AI 응답 JSON 키가 일치하는지 확인

---

## 🎯 요약

1. **코드 수정 완료:** `{{keyword}}`, `{{키워드}}`, `{{disease_code}}` 모두 지원
2. **프롬프트 수정:** `{{keyword}}` 사용, AI에게 명확한 JSON 구조 지시
3. **템플릿 수정 (선택):** `{{keyword}}`로 통일하면 더 명확
4. **테스트:** 키워드로 콘텐츠 생성 후 결과 확인

이제 프롬프트와 템플릿만 수정하면 정상적으로 변수가 치환됩니다! 🎉
